<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard – MetStud</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background: #f8fafc; color: #1e293b; }
    header { background: white; padding: 1rem 10%; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
    .logo { height: 36px; }
    main { padding: 2rem 10%; }
    .card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 2rem; }
    h1 { font-size: 1.8rem; margin-bottom: 1.5rem; }
    .filter-container { display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; }
    select { padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
    th { background: #f1f5f9; font-weight: 600; }
    .status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
    .pending { background: #fffbeb; color: #b45309; }
    .approved { background: #dcfce7; color: #166534; }
    .rejected { background: #fee2e2; color: #b91c1c; }
    button { padding: 0.4rem 0.8rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-right: 0.5rem; }
    .approve { background: #22c55e; color: white; }
    .reject { background: #ef4444; color: white; }
    .logout-btn { background: #64748b; color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; }
    .stats { display: flex; gap: 2rem; margin-bottom: 1rem; padding: 1rem; background: #f1f5f9; border-radius: 8px; }
    .stat-item { text-align: center; }
    .stat-number { font-size: 1.5rem; font-weight: 700; }
    .stat-label { font-size: 0.9rem; color: #64748b; }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="MetStud Logo" class="logo" />
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <main>
    <div class="card">
      <h1>Admission Applications</h1>

      <!-- Course Filter + Stats -->
      <div class="filter-container">
        <select id="courseFilter" onchange="filterApplications()">
          <option value="all">All Courses</option>
          <option value="AI & Machine Learning">AI & Machine Learning</option>
          <option value="Software Engineering">Software Engineering</option>
          <option value="Cyber Security">Cyber Security</option>
          <option value="Data Science">Data Science</option>
        </select>
        <div class="stats" id="courseStats">
          <div class="stat-item">
            <div class="stat-number" id="totalApps">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="aiApps">0</div>
            <div class="stat-label">AI & ML</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="seApps">0</div>
            <div class="stat-label">Software Eng</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="csApps">0</div>
            <div class="stat-label">Cyber Sec</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="dsApps">0</div>
            <div class="stat-label">Data Science</div>
          </div>
        </div>
      </div>

      <!-- Applications Table -->
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Program</th>
            <th>Email</th>
            <th>Applied</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="applications">
          <tr><td colspan="6">Loading applications...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
    let allApplications = [];

    // Check login status first
    async function checkLogin() {
      try {
        const res = await fetch('/api/admin/data');
        const data = await res.json();
        
        if (res.ok) {
          allApplications = data.admissions || [];
          renderStats();
          renderApplications(allApplications);
        } else {
          alert('You are not logged in. Redirecting to login...');
          window.location.href = 'admin.html';
        }
      } catch (err) {
        alert('Error checking login. Redirecting to login...');
        window.location.href = 'admin.html';
      }
    }

    // Render stats (counts per course)
    function renderStats() {
      const total = allApplications.length;
      const ai = allApplications.filter(a => a.program === 'AI & Machine Learning').length;
      const se = allApplications.filter(a => a.program === 'Software Engineering').length;
      const cs = allApplications.filter(a => a.program === 'Cyber Security').length;
      const ds = allApplications.filter(a => a.program === 'Data Science').length;

      document.getElementById('totalApps').textContent = total;
      document.getElementById('aiApps').textContent = ai;
      document.getElementById('seApps').textContent = se;
      document.getElementById('csApps').textContent = cs;
      document.getElementById('dsApps').textContent = ds;
    }

    // Filter applications by course
    function filterApplications() {
      const selectedCourse = document.getElementById('courseFilter').value;
      let filtered = allApplications;

      if (selectedCourse !== 'all') {
        filtered = allApplications.filter(app => app.program === selectedCourse);
      }

      renderApplications(filtered);
    }

    // Render applications table
    function renderApplications(apps) {
      if (!apps || apps.length === 0) {
        document.getElementById('applications').innerHTML = '<tr><td colspan="6">No applications yet.</td></tr>';
        return;
      }

      const html = apps.map(app => `
        <tr>
          <td>${app.fullName || 'N/A'}</td>
          <td>${app.program || 'N/A'}</td>
          <td>${app.email || 'N/A'}</td>
          <td>${app.applied || 'N/A'}</td>
          <td><span class="status ${app.status}">${app.status}</span></td>
          <td>
            ${app.status !== 'approved' ? `<button class="approve" onclick="updateStatus(${app.id}, 'approved')">Approve</button>` : '<span>✓ Approved</span>'}
            ${app.status !== 'rejected' ? `<button class="reject" onclick="updateStatus(${app.id}, 'rejected')">Reject</button>` : '<span>✗ Rejected</span>'}
          </td>
        </tr>
      `).join('');

      document.getElementById('applications').innerHTML = html;
    }

    // Update status
    async function updateStatus(id, status) {
      try {
        const res = await fetch('/api/admin/admission/status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, status })
        });
        const result = await res.json();
        if (result.success) {
          // Refresh data
          checkLogin();
        } else {
          alert('Failed to update status.');
        }
      } catch (err) {
        alert('Error updating status.');
      }
    }

    // Logout
    function logout() {
      if (confirm('Are you sure you want to log out?')) {
        window.location.href = 'admin.html';
      }
    }

    // Start
    checkLogin();
  </script>
</body>
</html>